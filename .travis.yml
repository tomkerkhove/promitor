sudo: required
language: csharp
dotnet: 2.1.403
services:
  - docker
os:  
  - linux
branches:  
 only:
   - master
jobs:
  include:
    - stage: General
      name: "Build, Test & Scan Codebase"
      script: ./build-test-scan-codebase.sh
    - name: "Build Docker Image Tests"
      script:
      - docker build ./src/ --file ./src/Promitor.Scraper.Host/Dockerfile --tag promitor-scraper-ci --no-cache
      - docker run -d -p 8999:80 --name promitor-ci --env PROMITOR_AUTH_APPID='${AZUREMONITOR_ID}' --env PROMITOR_AUTH_APPKEY='${AZUREMONITOR_KEY}' --volume /samples/promitor-sample.yaml:/config/metrics-declaration.yaml promitor-scraper-ci
      - sleep 10
      - curl -i -X GET "http://localhost:8999/api/v1/health"
