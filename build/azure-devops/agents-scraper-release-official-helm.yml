name: $(Image.Version)
resources:
- repo: self
trigger: none
pr: none
variables:
  # Helm.App.Version is configured in the build definition as settable at queue time
  # Helm.Chart.Version is configured in the build definition as settable at queue time
stages:
- stage: ReleaseHelm
  displayName: Release Helm Chart
  dependsOn: Build
  jobs:
   - job: PushHelmChart
     displayName: Push Helm Chart to ACR
     pool:
       vmImage: ubuntu-16.04
     steps:
     - task: HelmInstaller@0
       inputs:
        helmVersion: '2.9.1'
     - powershell: |
        mkdir output/
        helm package promitor-agent-scraper/ --app-version $(Helm.App.Version) --version $(Helm.Chart.Version) --destination output/
       workingDirectory: charts
       displayName: 'Package Helm Chart'
     - task: AzureCLI@1
       displayName: 'Push Helm Chart to Azure Container Registry'
       inputs:
        azureSubscription: 'Visual Studio Enterprise (0f9d7fea-99e8-4768-8672-06a28514f77e)'
        scriptLocation: inlineScript
        inlineScript: |
         az configure --defaults acr=promitor
         az acr helm push --name promitor charts/output/promitor-agent-scraper-$(Helm.Chart.Version).tgz --force