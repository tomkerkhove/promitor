name: $(Image.Version)
resources:
- repo: self
trigger: none
pr: none

parameters:
- name: releaseType
  displayName: Release Type
  type: string
  default: Full
  values:
  - Full
  - Preview
- name: imageVersion
  displayName: Image Version
  type: string
  default: 0.1.0
- name: githubReleaseTitle
  displayName: GitHub Release Title
  type: string
  default: Promitor Scraper v$(Image.Version)
- name: createGithubRelease
  displayName: Create GitHub Release
  type: boolean
  default: false

variables:
  - template: ./variables/tests.yml
  - template: ./variables/build.yml
  - template: ./variables/containers.yml
  - name: 'Image.Scraper.TaggedName'
    value: '$(Image.Scraper.Full):$(Image.Version)'
  - name: 'Release.TagName'
    value: 'Scraper-v$(Build.BuildNumber)'
  - name: 'Image.Version'
    value: '${{ parameters.imageVersion }}'
  - name: 'Release.Title'
    value: '${{ parameters.githubReleaseTitle }}'
  - name: 'OpenTelemetry.Collector.Uri'
    value: 'http://localhost:8889'
  - name: Container.OpenTelemetryCollector.Name
    value: 'opentelemetry.collector'

stages:
- stage: Init
  displayName: Prepare Release
  jobs:
   - job: DetermineVersion
     displayName: Determine Version
     pool:
       vmImage: ubuntu-latest
     steps:
     - template: templates/versioning/determine-major-minor-version.yml
     - template: templates/utils/persist-variable.yml
       parameters:
          currentVariableName: 'Image.MajorMinorVersion'
          persistedVariableName: 'Image.MajorMinorVersion'
     - publish: $(Pipeline.Workspace)/variables
       artifact: variables
- stage: Build
  dependsOn: Init
  displayName: Build and Push Docker image
  variables:
  - group: 'Agent Authentication'
  - name: Container.Scraper.Name
    value: 'promitor.scraper.agent'
  - name: Container.Scraper.Port
    value: 8999
  - name: Container.ResourceDiscovery.Name
    value: 'promitor.agents.resourcediscovery'
  - name: Container.ResourceDiscovery.Port
    value: '999'
  - name: Container.Network.Name
    value: 'ci-network'
  - name: Image.ResourceDiscovery.Local
    value: 'local/promitor-resource-discovery:dev'
  - name: Agent.Scraper.Version
    value: $(Image.Version)
  - name: Agent.Scraper.BaseUrl
    value: http://localhost:$(Container.Scraper.Port)
  - name: Agent.ResourceDiscovery.BaseUrl
    value: http://localhost:$(Container.ResourceDiscovery.Port)
  - name: Agent.ResourceDiscovery.Version
    value: NOTUSED
  jobs:
   - job: BuildLinux
     displayName: Build Linux Docker image
     pool:
       vmImage: ubuntu-latest
     variables:
       OS.Name: 'linux'
       Docker.Builder.Name: 'promitor-multiarch'
     steps:
     - download: current
       artifact: variables
     - template: templates/utils/read-variable-on-linux.yml
       parameters:
        variableName: 'Image.MajorMinorVersion'
     - template: templates/docker/linux-create-builder.yml
       parameters:
        builderName: '$(Docker.Builder.Name)'
     - template: templates/build/install-sdk.yml
       parameters:
        dotnetVersion: '$(DotNet.SDK.Version)'
     - task: DotNetCoreCLI@2
       displayName: 'Run Unit Tests'
       inputs:
        command: test
        projects: src/Promitor.Tests.Unit/Promitor.Tests.Unit.csproj
     - template: templates/docker/linux-build-image.yml
       parameters:
        builderName: '$(Docker.Builder.Name)'
        tags: >
          --tag $(Image.Scraper.TaggedName)
          --tag $(Image.Scraper.TaggedName)-$(OS.Name)
          --tag $(Image.Scraper.Full):$(Image.MajorMinorVersion)
          --tag $(Image.Scraper.Full):$(Image.MajorMinorVersion)-$(OS.Name)
          --tag $(Image.Scraper.Full):latest
          --tag $(Image.Scraper.Full):latest-$(OS.Name)
        dockerFile: './src/Promitor.Agents.Scraper/Dockerfile.$(OS.Name)'
        buildArgs: '--build-arg VERSION="$(Image.Version)"'
     - template: templates/docker/linux-build-image.yml
       parameters:
        builderName: '$(Docker.Builder.Name)'
        tags: >
          --tag $(Image.ResourceDiscovery.Local)
        platforms: 'linux/amd64'
        dockerFile: './src/Promitor.Agents.ResourceDiscovery/Dockerfile.$(OS.Name)'
        buildArgs: '--build-arg VERSION="$(Image.Version)"'
     - template: templates/docker/create-network.yml
       parameters:
        networkName: '$(Container.Network.Name)'
     - template: templates/agents/run-opentelemetry-collector.yml
       parameters:
          containerName: '$(Container.OpenTelemetryCollector.Name)'
          volumes: '$(Pipeline.Workspace)/s/config/opentelemetry-collector/collector-config.yaml:/etc/otel-collector-config.yaml'
          networkName: '$(Container.Network.Name)'
     - task: replacetokens@3
       displayName: Replace Tokens in Runtime Configuration
       inputs:
          rootDirectory: '$(Pipeline.Workspace)/s/config/promitor/scraper/'
          targetFiles: 'ci-runtime.yaml'
          encoding: 'auto'
          writeBOM: true
          verbosity: 'detailed'
          actionOnMissing: 'fail'
          keepToken: false
          tokenPrefix: '#{'
          tokenSuffix: '}#'
     - template: templates/agents/run-scraper-image.yml
       parameters:
          containerName: '$(Container.Scraper.Name)'
          containerPort: '$(Container.Scraper.Port)'
          imageName: '$(Image.Scraper.Full):$(Image.MajorMinorVersion)'
          volumes: '$(Pipeline.Workspace)/s/config/promitor/scraper/ci-runtime.yaml:/config/runtime.yaml --volume $(Pipeline.Workspace)/s/config/promitor/scraper/metrics.yaml:/config/metrics-declaration.yaml'
          activeDirectoryAppId: '$(Agent.Scraper.Auth.AppId)'
          activeDirectoryAppSecret: '$(Agent.Scraper.Auth.AppSecret)'
          networkName: '$(Container.Network.Name)'
          os: '$(OS.Name)'
     - template: templates/agents/run-discovery-image.yml
       parameters:
          imageName: '$(Image.ResourceDiscovery.Local)'
          containerName: '$(Container.ResourceDiscovery.Name)'
          containerPort: '$(Container.ResourceDiscovery.Port)'
          volumes: '$(Pipeline.Workspace)/s/config/promitor/resource-discovery/ci-runtime.yaml:/config/runtime.yaml --volume $(Pipeline.Workspace)/s/config/promitor/resource-discovery/resource-discovery-declaration.yaml:/config/resource-discovery-declaration.yaml'
          activeDirectoryAppId: '$(Agent.ResourceDiscovery.Auth.AppId)'
          activeDirectoryAppSecret: '$(Agent.ResourceDiscovery.Auth.AppSecret)'
          networkName: '$(Container.Network.Name)'
          os: '$(OS.Name)'
     - template: templates/docker/show-running-containers.yml
     - template: templates/tests/run-integration-tests.yml
       parameters:
          agentName: 'Scraper'
          testRunTitle: 'scraper-linux'
          dotnetVersion: '$(DotNet.Sdk.Version)'
          buildConfiguration: '$(DotNet.Configuration)'
     - template: templates/docker/show-container-logs.yml
       parameters:
        containerName: '$(Container.Scraper.Name)'
     - template: templates/docker/show-container-logs.yml
       parameters:
        containerName: '$(Container.ResourceDiscovery.Name)'
     - ${{ if eq(parameters['releaseType'], 'Full') }}:
        - template: templates/docker/linux-push-image.yml
          parameters:
            builderName: '$(Docker.Builder.Name)'
            tags: >
              --tag $(Image.Scraper.TaggedName)
              --tag $(Image.Scraper.TaggedName)-$(OS.Name)
              --tag $(Image.Scraper.Full):$(Image.MajorMinorVersion)
              --tag $(Image.Scraper.Full):$(Image.MajorMinorVersion)-$(OS.Name)
              --tag $(Image.Scraper.Full):latest
              --tag $(Image.Scraper.Full):latest-$(OS.Name)
            dockerFile: './src/Promitor.Agents.Scraper/Dockerfile.$(OS.Name)'
            buildArgs: '--build-arg VERSION="$(Image.Version)"'
     - ${{ if eq(parameters['releaseType'], 'Preview') }}:
        - template: templates/docker/linux-push-image.yml
          parameters:
            builderName: '$(Docker.Builder.Name)'
            tags: >
              --tag $(Image.Scraper.TaggedName)
              --tag $(Image.Scraper.TaggedName)-$(OS.Name)
            dockerFile: './src/Promitor.Agents.Scraper/Dockerfile.$(OS.Name)'
            buildArgs: '--build-arg VERSION="$(Image.Version)"'
   - job: BuildWindows
     displayName: Build Windows Docker image
     pool:
       vmImage: windows-latest
     variables:
       OS.Name: 'windows'
     steps:
     - template: templates/versioning/determine-major-minor-version.yml
     - template: templates/build/install-sdk.yml
       parameters:
        dotnetVersion: '$(DotNet.SDK.Version)'
     - task: DotNetCoreCLI@2
       displayName: 'Run Unit Tests'
       inputs:
        command: test
        projects: src/Promitor.Tests.Unit/Promitor.Tests.Unit.csproj
     - template: templates/agents/prepare-scraper-ci-config.yml
     - template: templates/agents/prepare-discovery-ci-config.yml
     - template: templates/docker/windows-build-image.yml
       parameters:
        imageDisplayName: '$(Image.ResourceDiscovery.Local)'
        dockerFile: './src/Promitor.Agents.ResourceDiscovery/Dockerfile.$(OS.Name)'
        repository: 'local/promitor-resource-discovery'
        tags: 'dev'
        buildArgs: '--build-arg VERSION="$(Image.Version)"'
     - template: templates/docker/windows-build-image.yml
       parameters:
        imageDisplayName: '$(Image.Scraper.TaggedName)-$(OS.Name)'
        dockerFile: './src/Promitor.Agents.Scraper/Dockerfile.$(OS.Name)'
        buildArgs: '--build-arg VERSION="$(Image.Version)"'
        repository: '$(Image.Scraper.Full)'
        tags: |
          $(Image.Version)-$(OS.Name)
          $(Image.MajorMinorVersion)-$(OS.Name)
          latest-$(OS.Name)
     - template: templates/docker/create-network.yml
       parameters:
        networkName: '$(Container.Network.Name)'
        driverName: 'nat'
     - task: replacetokens@3
       displayName: Replace Tokens in Runtime Configuration
       inputs:
          rootDirectory: '$(Pipeline.Workspace)\s\config\promitor\scraper\'
          targetFiles: 'ci-runtime.yaml'
          encoding: 'auto'
          writeBOM: true
          verbosity: 'detailed'
          actionOnMissing: 'fail'
          keepToken: false
          tokenPrefix: '#{'
          tokenSuffix: '}#'
     - template: templates/agents/run-scraper-image.yml
       parameters:
          containerName: '$(Container.Scraper.Name)'
          containerPort: '$(Container.Scraper.Port)'
          imageName: '$(Image.Scraper.Full):$(Image.MajorMinorVersion)-$(OS.Name)'
          volumes: '$(Pipeline.Workspace)\s\config\promitor\scraper\:c:\config\'
          activeDirectoryAppId: '$(Agent.Scraper.Auth.AppId)'
          activeDirectoryAppSecret: '$(Agent.Scraper.Auth.AppSecret)'
          networkName: '$(Container.Network.Name)'
          os: '$(OS.Name)'
     - template: templates/agents/run-discovery-image.yml
       parameters:
          imageName: '$(Image.ResourceDiscovery.Name)'
          containerName: '$(Container.ResourceDiscovery.Name)'
          containerPort: '$(Container.ResourceDiscovery.Port)'
          volumes: '$(Pipeline.Workspace)\s\config\promitor\resource-discovery\:c:\config\'
          activeDirectoryAppId: '$(Agent.ResourceDiscovery.Auth.AppId)'
          activeDirectoryAppSecret: '$(Agent.ResourceDiscovery.Auth.AppSecret)'
          networkName: '$(Container.Network.Name)'
          os: '$(OS.Name)'
     - template: templates/docker/show-running-containers.yml
     # Hack: Release is blocked because of task timing out while CI is fine
     #- template: templates/tests/run-integration-tests.yml
     #  parameters:
     #     agentName: 'Scraper'
     #     testRunTitle: 'scraper-windows'
     #     dotnetVersion: '$(DotNet.Sdk.Version)'
     #     buildConfiguration: '$(DotNet.Configuration)'
     - template: templates/docker/show-container-logs.yml
       parameters:
        containerName: '$(Container.Scraper.Name)'
     - template: templates/docker/show-container-logs.yml
       parameters:
        containerName: '$(Container.ResourceDiscovery.Name)'
     - template: templates/docker/windows-push-image.yml
       parameters:
        imageDisplayName: '''{major}.{minor}.{patch}-$(OS.Name)'''
        repository: '$(Image.Scraper.Repository)'
        tags: | 
          '$(Image.Version)-$(OS.Name)'
     - ${{ if eq(parameters['releaseType'], 'Full') }}:
        - template: templates/docker/windows-push-image.yml
          parameters:
            imageDisplayName: '''{major}.{minor}-$(OS.Name)'''
            repository: '$(Image.Scraper.Repository)'
            tags: | 
              '$(Image.MajorMinorVersion)-$(OS.Name)'
        - template: templates/docker/windows-push-image.yml
          parameters:
            imageDisplayName: '''latest-$(OS.Name)'''
            repository: '$(Image.Scraper.Repository)'
            tags: | 
              'latest-$(OS.Name)'
- ${{ if eq(parameters['createGitHubRelease'], true) }}:
  - stage: ReleaseGitHub
    displayName: Release on GitHub
    dependsOn: Build
    jobs:
    - job: CreateRelease
      displayName: Create Release
      pool:
        vmImage: ubuntu-latest
      steps:
      - download: current
        artifact: variables
      - template: templates/utils/read-variable-on-linux.yml
        parameters:
          variableName: 'Image.MajorMinorVersion'
      - ${{ if eq(parameters['releaseType'], 'Preview') }}:
          - task: GitHubRelease@0
            displayName: 'Create GitHub Pre-Release'
            inputs:
              gitHubConnection: 'Tom Kerkhove (GitHub - OAuth)'
              repositoryName: tomkerkhove/promitor
              action: Create
              tagSource: manual
              tag: '$(Release.TagName)'
              title: '$(Release.Title)'
              releaseNotesSource: input
              isPreRelease: true
              changeLogType: issueBased
              changeLogCompareToRelease: 'lastFullRelease'
              isDraft: true
              releaseNotes: |
                ### What's new?
                Here are some important things you should know, for a full list see [changelog.promitor.io](https://changelog.promitor.io/).
                #### Deprecations
                Here are a list of new deprecations and how to mitigate them:
                - TBW _(Discussion [#]())_
                #### Breaking Changes
                Here are a list of breaking changes and how to mitigate them:
                - TBW (#) - _Use new approach documented here_
                ### Getting started
                Running Promitor Scraper is super easy:
                ```
                docker run -d -p 8999:80 --name promitor-agent-scraper
                                  --env PROMITOR_AUTH_APPID='<azure-ad-app-id>'   \
                                  --env-file C:/Promitor/az-mon-auth.creds \
                                  --volume C:/Promitor/metrics-declaration.yaml:/config/metrics-declaration.yaml \
                                  ghcr.io/tomkerkhove/promitor-agent-scraper:$(Image.Version)
                ```
                ### Docker Image information
                New Docker image tags are available:
                - `$(Image.Version)`, `$(Image.Version)-linux`, `$(Image.Version)-windows`
                - `$(Image.MajorMinorVersion)`, `$(Image.MajorMinorVersion)-linux`, `$(Image.MajorMinorVersion)-windows`

                Docker image is available on [GitHub Container Registry](https://github.com/tomkerkhove?tab=packages&repo_name=promitor&ecosystem=container).<br />
                For more information about our tagging strategy, feel free to read our [documentation](https://docs.promitor.io/deployment/#image-tagging-strategy).
      - ${{ if eq(parameters['releaseType'], 'Full') }}:
          - task: GitHubRelease@0
            displayName: 'Create GitHub Pre-Release'
            inputs:
              gitHubConnection: 'Tom Kerkhove (GitHub - OAuth)'
              repositoryName: tomkerkhove/promitor
              action: Create
              tagSource: manual
              tag: '$(Release.TagName)'
              title: '$(Release.Title)'
              releaseNotesSource: input
              changeLogType: issueBased
              changeLogCompareToRelease: 'lastFullRelease'
              isPreRelease: false
              isDraft: true
              releaseNotes: |
                ### What's new?
                Here are some important things you should know, for a full list see [changelog.promitor.io](https://changelog.promitor.io/).
                #### Deprecations
                Here are a list of new deprecations and how to mitigate them:
                - TBW _(Discussion [#]())_
                #### Breaking Changes
                Here are a list of breaking changes and how to mitigate them:
                - TBW (#) - _Use new approach documented here_
                ### Getting started
                Running Promitor Scraper is super easy:
                ```
                docker run -d -p 8999:80 --name promitor-agent-scraper
                                  --env PROMITOR_AUTH_APPID='<azure-ad-app-id>'   \
                                  --env-file C:/Promitor/az-mon-auth.creds \
                                  --volume C:/Promitor/metrics-declaration.yaml:/config/metrics-declaration.yaml \
                                  ghcr.io/tomkerkhove/promitor-agent-scraper:$(Image.Version)
                ```
                ### Docker Image information
                New Docker image tags are available:
                - `latest`, `latest-linux`, `latest-windows`
                - `$(Image.Version)`, `$(Image.Version)-linux`, `$(Image.Version)-windows`
                - `$(Image.MajorMinorVersion)`, `$(Image.MajorMinorVersion)-linux`, `$(Image.MajorMinorVersion)-windows`

                Docker image is available on [GitHub Container Registry](https://github.com/tomkerkhove?tab=packages&repo_name=promitor&ecosystem=container).<br />
                For more information about our tagging strategy, feel free to read our [documentation](https://docs.promitor.io/deployment/#image-tagging-strategy).
