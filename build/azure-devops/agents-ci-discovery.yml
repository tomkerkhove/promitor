name: $(Date:yyyyMMdd)$(Rev:r)
resources:
- repo: self
trigger:
- master
pr:
  branches:
    include:
    - master
  paths:
    include:
    - src/**
    - config/promitor/*
    - build/azure-devops/templates/*
    - build/azure-devops/agents-ci-discovery.yml
variables:
  - template: ./variables/build.yml
  - template: ./variables/tests.yml
  - template: ./variables/containers.yml
  - name: Image.Name
    value: 'promitor-agent-resource-discovery-ci'
  - name: Image.Repository
    value: '$(Image.Organization)/$(Image.Name)'
  - name: Image.Name.Full
    value: '$(Image.Registry)/$(Image.Repository)'
  - name: Image.TaggedName
    value: '$(Image.Name.Full):$(Tags.PR)'
  - name: Container.Name
    value: 'promitor-discovery-agent'
  - name: App.Version
    value: '0.0.0-$(Image.Tag)'
  - name: OpenTelemetry.Collector.Uri
    value: http://notused:8889
stages:
- stage: Init
  displayName: Prepare Build
  dependsOn: []
  jobs:
   - job: DetermineVersion
     displayName: Determine Version
     pool:
       vmImage: ubuntu-latest
     steps:
     - ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
        - template: templates/versioning/determine-pr-version.yml
     - template: templates/utils/persist-variable.yml
       parameters:
        currentVariableName: 'Build.BuildNumber'
        persistedVariableName: 'Image.Tag'
     - publish: $(Pipeline.Workspace)/variables
       artifact: variables
- stage: Docker
  displayName: Docker Image
  dependsOn: [Init]
  variables:
  - group: 'Agent Authentication'
  - name: Image.TaggedName.OSAgnostic
    value: '$(Image.Name.Full):$(Image.Tag)'
  - name: Tags.PR
    value: '$(Image.Tag)-$(OS.Name)'
  - name: Container.Port
    value: 8889
  - name: Agent.ResourceDiscovery.BaseUrl
    value: http://localhost:$(Container.Port)
  - name: Agent.ResourceDiscovery.Version
    value: $(App.Version)
  - name: Agent.Scraper.BaseUrl
    value: NOTUSED
  - name: Agent.Scraper.Version
    value: NOTUSED
  jobs:
   - job: DockerBuildLinux
     displayName: Build Docker Image (Linux)
     condition: succeeded()
     timeoutInMinutes: 180
     pool:
       vmImage: ubuntu-latest
     variables:
       Tags.Experimental: 'experimental-$(OS.Name)'
       OS.Name: 'linux'
       Docker.Builder.Name: 'promitor-multiarch'
     steps:
     - download: current
       artifact: variables
     - template: templates/utils/read-variable-on-linux.yml
       parameters:
        variableName: 'Image.Tag'
     - template: templates/docker/linux-create-builder.yml
       parameters:
        builderName: '$(Docker.Builder.Name)'
     - ${{ if not(eq(variables['Build.Reason'], 'PullRequest')) }}:
        - template: templates/docker/linux-build-image.yml
          parameters:
             builderName: '$(Docker.Builder.Name)'
             dockerFile: './src/Promitor.Agents.ResourceDiscovery/Dockerfile.$(OS.Name)'
             tags: '--tag $(Image.TaggedName) --tag promitor-agent-resource-discovery-ci'
             buildArgs: '--build-arg VERSION="$(App.Version)"'
     - ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
        - template: templates/docker/linux-build-image.yml
          parameters:
             builderName: '$(Docker.Builder.Name)'
             dockerFile: './src/Promitor.Agents.ResourceDiscovery/Dockerfile.$(OS.Name)'
             tags: '--tag $(Image.TaggedName) --tag promitor-agent-resource-discovery-ci --tag $(Image.TaggedName.OSAgnostic)'
             buildArgs: '--build-arg VERSION="$(App.Version)"'
     - template: templates/agents/run-discovery-image.yml
       parameters:
          imageName: '$(Image.TaggedName)'
          containerName: '$(Container.Name)'
          containerPort: '$(Container.Port)'
          volumes: '$(Pipeline.Workspace)/s/config/promitor/resource-discovery/ci-runtime.yaml:/config/runtime.yaml --volume $(Pipeline.Workspace)/s/config/promitor/resource-discovery/resource-discovery-declaration.yaml:/config/resource-discovery-declaration.yaml'
          activeDirectoryAppId: '$(Agent.ResourceDiscovery.Auth.AppId)'
          activeDirectoryAppSecret: '$(Agent.ResourceDiscovery.Auth.AppSecret)'
          os: '$(OS.Name)'
     - template: templates/docker/show-running-containers.yml
     - template: templates/tests/run-integration-tests.yml
       parameters:
        agentName: 'Resource Discovery'
        testRunTitle: 'resource-discovery-linux'
        dotnetVersion: '$(DotNet.Sdk.Version)'
        buildConfiguration: '$(DotNet.Configuration)'
     - template: templates/docker/show-container-logs.yml
       parameters:
        containerName: '$(Container.Name)'
     - template: templates/prometheus/show-prometheus-metrics.yml
       parameters:
        agentName: 'Resource Discovery'
        url: '$(Agent.ResourceDiscovery.BaseUrl)/$(Agent.ResourceDiscovery.Prometheus.ScrapeUri)'
     - ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
        - template: templates/docker/linux-push-image.yml
          parameters:
              builderName: '$(Docker.Builder.Name)'
              dockerFile: './src/Promitor.Agents.ResourceDiscovery/Dockerfile.$(OS.Name)'
              tags: >
                --tag $(Image.TaggedName)
                --tag $(Image.TaggedName.OSAgnostic)
              buildArgs: '--build-arg VERSION="$(App.Version)"'
   - job: DockerBuildWindows
     displayName: Build Docker Image (Windows)
     condition: succeeded()
     timeoutInMinutes: 180
     pool:
       vmImage: windows-latest
     variables:
       OS.Name: 'windows'
     steps:
     - download: current
       artifact: variables
     - template: templates/utils/read-variable-on-windows.yml
       parameters:
        variableName: 'Image.Tag'
     - ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
        - template: templates/versioning/determine-pr-version.yml
     - template: templates/agents/prepare-discovery-ci-config.yml
     - ${{ if not(eq(variables['Build.Reason'], 'PullRequest')) }}:
        - template: templates/docker/windows-build-image.yml
          parameters:
             imageDisplayName: '$(Image.TaggedName)'
             dockerFile: './src/Promitor.Agents.ResourceDiscovery/Dockerfile.$(OS.Name)'
             buildArgs: '--build-arg VERSION="$(App.Version)"'
             repository: '$(Image.Name.Full)'
             tags: |
               $(Tags.PR)
     - ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
        - template: templates/docker/windows-build-image.yml
          parameters:
             imageDisplayName: '$(Image.TaggedName)'
             dockerFile: './src/Promitor.Agents.ResourceDiscovery/Dockerfile.$(OS.Name)'
             buildArgs: '--build-arg VERSION="$(App.Version)"'
             repository: '$(Image.Name.Full)'
             tags: |
               $(Tags.PR)
               $(Image.Tag)
     - template: templates/agents/run-discovery-image.yml
       parameters:
          imageName: '$(Image.TaggedName)'
          containerName: '$(Container.Name)'
          containerPort: '$(Container.Port)'
          volumes: '$(Pipeline.Workspace)\s\config\promitor\resource-discovery\:c:\config\'
          activeDirectoryAppId: '$(Agent.ResourceDiscovery.Auth.AppId)'
          activeDirectoryAppSecret: '$(Agent.ResourceDiscovery.Auth.AppSecret)'
          os: '$(OS.Name)'
     - template: templates/docker/show-running-containers.yml
     - template: templates/tests/run-integration-tests.yml
       parameters:
        agentName: 'Resource Discovery'
        testRunTitle: 'resource-discovery-windows'
        dotnetVersion: '$(DotNet.Sdk.Version)'
        buildConfiguration: '$(DotNet.Configuration)'
     - template: templates/docker/show-container-logs.yml
       parameters:
        containerName: '$(Container.Name)'
     - template: templates/prometheus/show-prometheus-metrics.yml
       parameters:
        agentName: 'Resource Discovery'
        url: '$(Agent.ResourceDiscovery.BaseUrl)/$(Agent.ResourceDiscovery.Prometheus.ScrapeUri)'
     - ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
        - template: templates/docker/windows-push-image.yml
          parameters:
              imageDisplayName: '$(Image.TaggedName)'
              repository: '$(Image.Repository)'
              tags: '$(Tags.PR)'
