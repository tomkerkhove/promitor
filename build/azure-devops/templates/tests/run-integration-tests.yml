parameters:
- name: agentName
  type: string
- name: dotnetVersion
  type: string
- name: buildConfiguration
  type: string
- name: additionalTestFilters
  type: string
  default: ''

steps:
- template: ./../../build/install-sdk.yml
  parameters:
    dotnetVersion: '${{ parameters.dotnetVersion }}'
- powershell: |
    $testFilter = 'Agent=${{ parameters.agentName }}';
    if ('${{ parameters.additionalTestFilters }}' -ne '') {
      $testFilter = 'Agent=${{ parameters.agentName }}&${{ parameters.additionalTestFilters }}';
    }
    Write-Host "Test Filter = $testFilter"
    Write-Host "##vso[task.setvariable variable=testFilter]$testFilter"
  displayName: 'Determine test filters'
- task: replacetokens@3
  displayName: Replace Tokens in Integration Test Configuration (${{ parameters.agentName }} Agent)
  inputs:
    rootDirectory: './src'
    targetFiles: '**/appsettings.json'
    encoding: 'auto'
    writeBOM: true
    verbosity: 'detailed'
    actionOnMissing: 'fail'
    keepToken: false
    tokenPrefix: '#{'
    tokenSuffix: '}#'
- task: DotNetCoreCLI@2
  displayName: 'Run Integration Tests'
  inputs:
    command: test
    includeNuGetOrg: true
    projects: 'src/Promitor.Tests.Integration/Promitor.Tests.Integration.csproj'
    feedsToUse: 'config'
    nugetConfigPath: 'src/NuGet.config'
    arguments: '--configuration ${{ parameters.buildConfiguration }} --filter "$(testFilter)"'
