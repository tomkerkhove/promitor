name: $(Image.Version)
resources:
- repo: self
trigger: none
pr: none

parameters:
- name: releaseType
  displayName: Release Type
  type: string
  default: Full
  values:
  - Full
  - Preview
- name: imageVersion
  displayName: Image Version
  type: string
  default: 0.1.0
- name: githubReleaseTitle
  displayName: GitHub Release Title
  type: string
  default: Promitor Resource Discovery v$(Image.Version)
- name: createGithubRelease
  displayName: Create GitHub Release
  type: boolean
  default: false

variables:
  - template: ./variables/tests.yml
  - template: ./variables/build.yml
  - template: ./variables/containers.yml
  - name: 'Image.Version'
    value: '${{ parameters.imageVersion }}'
  - name: 'Release.Title'
    value: '${{ parameters.githubReleaseTitle }}'
  - name: 'Image.ResourceDiscovery.TaggedName'
    value: '$(Image.ResourceDiscovery.Full):$(Image.Version)'
  - name: 'Release.TagName'
    value: 'ResourceDiscovery-v$(Build.BuildNumber)'
  # Required for all our build stages
  - group: 'Agent Authentication'
  - name: Container.Scraper.Name
    value: 'promitor.scraper.agent'
  - name: Container.Scraper.Port
    value: 8999
  - name: Container.ResourceDiscovery.Name
    value: 'promitor.agents.resourcediscovery'
  - name: Container.ResourceDiscovery.Port
    value: '999'
  - name: Agent.Scraper.BaseUrl
    value: http://localhost:$(Container.Scraper.Port)
  - name: Agent.ResourceDiscovery.BaseUrl
    value: http://localhost:$(Container.ResourceDiscovery.Port)
  - name: Agent.Scraper.Version
    value: NOTUSED
  - name: Agent.ResourceDiscovery.Version
    value: $(Image.Version)
  - name: OpenTelemetry.Collector.Uri
    value: http://notused:8889

stages:
- stage: Init
  displayName: Prepare Release
  jobs:
   - job: DetermineVersion
     displayName: Determine Version
     pool:
       vmImage: ubuntu-latest
     steps:
     - template: templates/versioning/determine-major-minor-version.yml
     - template: templates/utils/persist-variable.yml
       parameters:
          currentVariableName: 'Image.MajorMinorVersion'
          persistedVariableName: 'Image.MajorMinorVersion'
     - publish: $(Pipeline.Workspace)/variables
       artifact: variables
- stage: BuildLinux
  dependsOn: Init
  displayName: Linux Docker image
  pool:
    vmImage: ubuntu-latest
  variables:
  - name: OS.Name
    value: 'linux'
  - name: Docker.Builder.Name
    value: 'promitor-multiarch'
  jobs:
   - job: BuildLinux
     displayName: Build Linux Docker image
     steps:
     - download: current
       artifact: variables
     - template: templates/utils/read-variable-on-linux.yml
       parameters:
        variableName: 'Image.MajorMinorVersion'
     - template: templates/docker/linux-create-builder.yml
       parameters:
        builderName: '$(Docker.Builder.Name)'
     - template: templates/build/install-sdk.yml
       parameters:
        dotnetVersion: '$(DotNet.SDK.Version)'
     - task: DotNetCoreCLI@2
       displayName: 'Run Unit Tests'
       inputs:
        command: test
        projects: src/Promitor.Tests.Unit/Promitor.Tests.Unit.csproj
     - template: templates/docker/linux-build-image.yml
       parameters:
        builderName: '$(Docker.Builder.Name)'
        tags: >
          --tag $(Image.ResourceDiscovery.TaggedName)
          --tag $(Image.ResourceDiscovery.TaggedName)-$(OS.Name)
          --tag $(Image.ResourceDiscovery.Full):$(Image.MajorMinorVersion)
          --tag $(Image.ResourceDiscovery.Full):$(Image.MajorMinorVersion)-$(OS.Name)
          --tag $(Image.ResourceDiscovery.Full):latest
          --tag $(Image.ResourceDiscovery.Full):latest-$(OS.Name)
        dockerFile: './src/Promitor.Agents.ResourceDiscovery/Dockerfile.$(OS.Name)'
        buildArgs: '--build-arg VERSION="$(Image.Version)"'
     - template: templates/agents/run-discovery-image.yml
       parameters:
          imageName: '$(Image.ResourceDiscovery.Name)'
          containerName: '$(Container.ResourceDiscovery.Name)'
          containerPort: '$(Container.ResourceDiscovery.Port)'
          volumes: '$(Pipeline.Workspace)/s/config/promitor/resource-discovery/ci-runtime.yaml:/config/runtime.yaml --volume $(Pipeline.Workspace)/s/config/promitor/resource-discovery/resource-discovery-declaration.yaml:/config/resource-discovery-declaration.yaml'
          activeDirectoryAppId: '$(Agent.ResourceDiscovery.Auth.AppId)'
          activeDirectoryAppSecret: '$(Agent.ResourceDiscovery.Auth.AppSecret)'
          os: '$(OS.Name)'
     - template: templates/docker/show-running-containers.yml
     - template: templates/tests/run-integration-tests.yml
       parameters:
        agentName: 'Resource Discovery'
        testRunTitle: 'resource-discovery-linux'
        dotnetVersion: '$(DotNet.Sdk.Version)'
        buildConfiguration: '$(DotNet.Configuration)'
     - template: templates/docker/show-container-logs.yml
       parameters:
        containerName: '$(Container.ResourceDiscovery.Name)'
     - ${{ if eq(parameters['releaseType'], 'Full') }}:
        - template: templates/docker/linux-push-image.yml
          parameters:
            builderName: '$(Docker.Builder.Name)'
            tags: >
              --tag $(Image.ResourceDiscovery.TaggedName)
              --tag $(Image.ResourceDiscovery.TaggedName)-$(OS.Name)
              --tag $(Image.ResourceDiscovery.Full):$(Image.MajorMinorVersion)
              --tag $(Image.ResourceDiscovery.Full):$(Image.MajorMinorVersion)-$(OS.Name)
              --tag $(Image.ResourceDiscovery.Full):latest
              --tag $(Image.ResourceDiscovery.Full):latest-$(OS.Name)
            dockerFile: './src/Promitor.Agents.ResourceDiscovery/Dockerfile.$(OS.Name)'
            buildArgs: '--build-arg VERSION="$(Image.Version)"'
            platforms: 'linux/amd64,linux/arm64'
     - ${{ if eq(parameters['releaseType'], 'Preview') }}:
        - template: templates/docker/linux-push-image.yml
          parameters:
            builderName: '$(Docker.Builder.Name)'
            tags: >
              --tag $(Image.ResourceDiscovery.TaggedName)
              --tag $(Image.ResourceDiscovery.TaggedName)-$(OS.Name)
            dockerFile: './src/Promitor.Agents.ResourceDiscovery/Dockerfile.$(OS.Name)'
            buildArgs: '--build-arg VERSION="$(Image.Version)"'
            platforms: 'linux/amd64,linux/arm64'
- stage: BuildWindows
  dependsOn: Init
  displayName: Windows Docker image
  pool:
    vmImage: windows-latest
  variables:
  - name: OS.Name
    value: 'windows'
  jobs:
   - job: BuildWindows
     displayName: Build Windows Docker image
     steps:
     - template: templates/versioning/determine-major-minor-version.yml
     - template: templates/build/install-sdk.yml
       parameters:
        dotnetVersion: '$(DotNet.SDK.Version)'
     - task: DotNetCoreCLI@2
       displayName: 'Run Unit Tests'
       inputs:
        command: test
        projects: src/Promitor.Tests.Unit/Promitor.Tests.Unit.csproj
     - template: templates/agents/prepare-discovery-ci-config.yml
     - template: templates/docker/windows-build-image.yml
       parameters:
        imageDisplayName: '$(Image.ResourceDiscovery.TaggedName)-$(OS.Name)'
        dockerFile: './src/Promitor.Agents.ResourceDiscovery/Dockerfile.$(OS.Name)'
        repository: '$(Image.ResourceDiscovery.Full)'
        tags: |
          $(Image.Version)-$(OS.Name)
          $(Image.MajorMinorVersion)-$(OS.Name)
          latest-$(OS.Name)
        buildArgs: '--build-arg VERSION="$(Image.Version)"'
     - template: templates/agents/run-discovery-image.yml
       parameters:
          imageName: '$(Image.ResourceDiscovery.Name):$(Image.MajorMinorVersion)-$(OS.Name)'
          containerName: '$(Container.ResourceDiscovery.Name)'
          containerPort: '$(Container.ResourceDiscovery.Port)'
          volumes: '$(Pipeline.Workspace)\s\config\promitor\resource-discovery\:c:\config\'
          activeDirectoryAppId: '$(Agent.ResourceDiscovery.Auth.AppId)'
          activeDirectoryAppSecret: '$(Agent.ResourceDiscovery.Auth.AppSecret)'
          os: '$(OS.Name)'
     - template: templates/docker/show-running-containers.yml
     - template: templates/tests/run-integration-tests.yml
       parameters:
        agentName: 'Resource Discovery'
        testRunTitle: 'resource-discovery-windows'
        dotnetVersion: '$(DotNet.Sdk.Version)'
        buildConfiguration: '$(DotNet.Configuration)'
     - template: templates/docker/show-container-logs.yml
       parameters:
        containerName: '$(Container.ResourceDiscovery.Name)'
     - template: templates/docker/windows-push-image.yml
       parameters:
        imageDisplayName: '''{major}.{minor}.{patch}-$(OS.Name)'''
        repository: '$(Image.ResourceDiscovery.Repository)'
        tags: | 
          '$(Image.Version)-$(OS.Name)'
     - ${{ if eq(parameters['releaseType'], 'Full') }}:
        - template: templates/docker/windows-push-image.yml
          parameters:
            imageDisplayName: '''{major}.{minor}-$(OS.Name)'''
            repository: '$(Image.ResourceDiscovery.Repository)'
            tags: | 
              '$(Image.MajorMinorVersion)-$(OS.Name)'
        - template: templates/docker/windows-push-image.yml
          parameters:
            imageDisplayName: '''latest-$(OS.Name)'''
            repository: '$(Image.ResourceDiscovery.Repository)'
            tags: | 
              'latest-$(OS.Name)'
- ${{ if eq(parameters['createGitHubRelease'], true) }}:
  - stage: ReleaseGitHub
    displayName: Release on GitHub
    dependsOn: [BuildLinux,BuildWindows]
    jobs:
    - job: CreateRelease
      displayName: Create Release
      pool:
        vmImage: ubuntu-latest
      steps:
      - download: current
        artifact: variables
      - template: templates/utils/read-variable-on-linux.yml
        parameters:
          variableName: 'Image.MajorMinorVersion'
      - ${{ if eq(parameters['releaseType'], 'Preview') }}:
          - task: GitHubRelease@0
            displayName: 'Create GitHub Pre-Release'
            inputs:
              gitHubConnection: 'Tom Kerkhove (GitHub - OAuth)'
              repositoryName: tomkerkhove/promitor
              action: Create
              tagSource: manual
              tag: '$(Release.TagName)'
              title: '$(Release.Title)'
              releaseNotesSource: input
              isPreRelease: true
              changeLogType: issueBased
              changeLogCompareToRelease: 'lastFullRelease'
              isDraft: true
              releaseNotes: |
                ### What's new?
                Here are some important things you should know, for a full list see [changelog.promitor.io](https://changelog.promitor.io/).
                #### Deprecations
                Here are a list of new deprecations and how to mitigate them:
                - TBW _(Discussion [#]())_
                #### Breaking Changes
                Here are a list of breaking changes and how to mitigate them:
                - TBW (#) - _Use new approach documented here_
                ### Getting started
                Running Promitor Resource Discovery is super easy:
                ```
                docker run -d -p 9999:80 --name promitor-agent-resource-discovery   \
                                  --env PROMITOR_AUTH_APPID='<azure-ad-app-id>'   \
                                  --env-file C:/Promitor/promitor-discovery-auth.creds   \
                                  --volume C:/Promitor/resource-discovery-declaration.yaml:/config/resource-discovery-declaration.yaml   \
                                  --volume C:/Promitor/resource-discovery-runtime.yaml:/config/runtime.yaml   \
                                  ghcr.io/tomkerkhove/promitor-agent-resource-discovery:$(Image.Version)
                ```
                ### Docker Image information
                New Docker image tags are available:
                - `$(Image.Version)`, `$(Image.Version)-linux`, `$(Image.Version)-windows`
                - `$(Image.MajorMinorVersion)`, `$(Image.MajorMinorVersion)-linux`, `$(Image.MajorMinorVersion)-windows`

                Docker image is available on [GitHub Container Registry](https://github.com/tomkerkhove?tab=packages&repo_name=promitor&ecosystem=container).<br />
                For more information about our tagging strategy, feel free to read our [documentation](https://docs.promitor.io/deployment/#image-tagging-strategy).
      - ${{ if eq(parameters['releaseType'], 'Full') }}:
          - task: GitHubRelease@0
            displayName: 'Create GitHub Pre-Release'
            inputs:
              gitHubConnection: 'Tom Kerkhove (GitHub - OAuth)'
              repositoryName: tomkerkhove/promitor
              action: Create
              tagSource: manual
              tag: '$(Release.TagName)'
              title: '$(Release.Title)'
              releaseNotesSource: input
              changeLogType: issueBased
              changeLogCompareToRelease: 'lastFullRelease'
              isPreRelease: false
              isDraft: true
              releaseNotes: |
                ### What's new?
                Here are some important things you should know, for a full list see [changelog.promitor.io](https://changelog.promitor.io/).
                #### Deprecations
                Here are a list of new deprecations and how to mitigate them:
                - TBW _(Discussion [#]())_
                #### Breaking Changes
                Here are a list of breaking changes and how to mitigate them:
                - TBW (#) - _Use new approach documented here_
                ### Getting started
                Running Promitor Resource Discovery is super easy:
                ```
                docker run -d -p 9999:80 --name promitor-agent-resource-discovery   \
                                  --env PROMITOR_AUTH_APPID='<azure-ad-app-id>'   \
                                  --env-file C:/Promitor/promitor-discovery-auth.creds   \
                                  --volume C:/Promitor/resource-discovery-declaration.yaml:/config/resource-discovery-declaration.yaml   \
                                  --volume C:/Promitor/resource-discovery-runtime.yaml:/config/runtime.yaml   \
                                  ghcr.io/tomkerkhove/promitor-agent-resource-discovery:$(Image.Version)
                ```
                ### Docker Image information
                New Docker image tags are available:
                - `latest`, `latest-linux`, `latest-windows`
                - `$(Image.Version)`, `$(Image.Version)-linux`, `$(Image.Version)-windows`
                - `$(Image.MajorMinorVersion)`, `$(Image.MajorMinorVersion)-linux`, `$(Image.MajorMinorVersion)-windows`

                Docker image is available on [GitHub Container Registry](https://github.com/tomkerkhove?tab=packages&repo_name=promitor&ecosystem=container).<br />
                For more information about our tagging strategy, feel free to read our [documentation](https://docs.promitor.io/deployment/#image-tagging-strategy).
