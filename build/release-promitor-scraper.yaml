resources:
- repo: self
queue:
  name: Hosted Linux Preview
  condition: succeeded()
  demands: npm
variables:
  Image.Name: 'tomkerkhove/promitor-scraper:$(Build.BuildNumber)'
steps:
- task: Docker@1
  displayName: Build Docker image
  inputs:
    dockerFile: './src/Promitor.Scraper.Host/Dockerfile'
    useDefaultContext: false
    buildContext: './src/'
    imageName: '$(Image.Name)'

- task: marcelo-formentao.github-tools.github-release-publish-task.GitHubReleasePublish@0
  displayName: Create GitHub Release (Conditional Step)
  inputs:
    githubEndpoint: 'Tom Kerkhove (GitHub - OAuth)'
    githubRepository: 'tomkerkhove/promitor'
    githubTag: '$(Build.BuildNumber)'
    githubReleaseTitle: '$(Release.Title)'
    githubReleaseNotes: |
     ### Getting started
     Running Promitor Scraper is super easy:
     ```
     docker run -d -p 8999:80 -e PROMITOR_AUTH_APPID='<azure-ad-app-id>'   \
                              -e PROMITOR_AUTH_APPKEY='<azure-ad-app-key>' \
                              -e PROMITOR_TELEMETRY_INSTRUMENTATIONKEY='<azure-application-insights-key>' \
                              -v C:/Promitor/metrics-declaration.yaml:/config/metrics-declaration.yaml \ 
                              tomkerkhove/promitor-scraper:0.2.0-azure-applicationinsights-1
     ```
     
     Docker image is available on [Docker Hub](https://hub.docker.com/r/tomkerkhove/promitor-scraper/).
     
     ### New features/changes
     - #<issue> **To be defined**
    githubReleaseDraft: false
    githubReleaseAsset: '$(Build.ArtifactStagingDirectory)/Promitor-Scraper-$(Build.BuildNumber).zip'
    githubReuseRelease: false
    githubReuseDraftOnly: false
  condition: not(contains(variables['Build.BuildNumber'], '-'))

- task: marcelo-formentao.github-tools.github-release-publish-task.GitHubReleasePublish@0
  displayName: Create GitHub Pre-Release (Conditional Step)
  inputs:
    githubEndpoint: 'Tom Kerkhove (GitHub - OAuth)'
    githubRepository: 'tomkerkhove/promitor'
    githubTag: '$(Build.BuildNumber)'
    githubReleaseTitle: '$(Release.Title)'
    githubReleaseNotes: |
     ### Getting started
     Running Promitor Scraper is super easy:
     ```
     docker run -d -p 8999:80 -e PROMITOR_AUTH_APPID='<azure-ad-app-id>'   \
                              -e PROMITOR_AUTH_APPKEY='<azure-ad-app-key>' \
                              -e PROMITOR_TELEMETRY_INSTRUMENTATIONKEY='<azure-application-insights-key>' \
                              -v C:/Promitor/metrics-declaration.yaml:/config/metrics-declaration.yaml \ 
                              tomkerkhove/promitor-scraper:0.2.0-azure-applicationinsights-1
     ```
     
     Docker image is available on [Docker Hub](https://hub.docker.com/r/tomkerkhove/promitor-scraper/).
     
     ### New features/changes
     - #<issue> **To be defined**    
     
     ### Previews
     - #<issue> **To be defined**
    githubReleaseDraft: false
    githubReleasePrerelease: true
    githubReleaseAsset: '$(Build.ArtifactStagingDirectory)/Promitor-Scraper-$(Build.BuildNumber).zip'
    githubReuseRelease: false
    githubReuseDraftOnly: false
  condition: contains(variables['Build.BuildNumber'], '-')

- task: Docker@1
  displayName: Push to Docker Hub
  inputs:
    containerregistrytype: 'Container Registry'
    dockerRegistryEndpoint: 'Docker Hub'
    command: 'Push an image'
    imageName: '$(Image.Name)'